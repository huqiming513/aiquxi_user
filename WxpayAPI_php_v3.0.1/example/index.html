
<html>
<head>
    <meta http-equiv="content-type" content="text/html;charset=utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        .pay{
            display: block;text-align: center;background-color: #00d7f6;width: 60%;margin: 20px auto;font-size:22px;line-height: 30px;padding: 10px;
            border-radius: 10px;
            margin-top: 150px;
        }
    </style>
    <title>支付页面</title>
    <script src="jquery-3.2.1.min.js"></script>
    <link>
    <script>
        window.base={
             g_restUrl:'https://www.aiquxi.net/aiquxi/public/index.php/',
            getData:function(params){
                if(!params.type){
                    params.type='post';
                }
                var that=this;
                $.ajax({
                    type:params.type,
                    async: false,
                    url:this.g_restUrl+params.url,
                    data:params.data,
                    beforeSend: function (XMLHttpRequest) {
                        if (params.tokenFlag) {
                            XMLHttpRequest.setRequestHeader('token', that.getLocalStorage('token'));
                         //   XMLHttpRequest.setRequestHeader('token', "7003d3551a7464928ee46b9844a2eae8")
                        }
                        //  $(".loading_area").fadeIn();

                    },
                    success:function(res){
                        params.sCallback && params.sCallback(res);
                    },
                    error:function(res){
                        params.eCallback && params.eCallback(res);
                    },
                    complete:function(XMLHttpRequest){
                        //  $(".loading_area").fadeOut();
                    }
                });
            },

            setLocalStorage:function(key,val){
                var exp=new Date().getTime()+24*60*60*100;  //令牌过期时间
                var obj={
                    val:val,
                    exp:exp
                };
                localStorage.setItem(key,JSON.stringify(obj));
            },

            getLocalStorage:function(key){
                var info= localStorage.getItem(key);
                if(info) {
                    info = JSON.parse(info);
                    if (info.exp > new Date().getTime()) {
                        return info.val;
                    }
                    else{
                        this.deleteLocalStorage('token');
                    }
                }
                return '';
            },

            deleteLocalStorage:function(key){
                return localStorage.removeItem(key);
            },

        }

        function setImagePreview(fileObj, previewObj,width, localImg) {
            var docObj=document.getElementById(fileObj);
            var imgObjPreview=document.getElementById(previewObj);
            var wid=arguments[2] ? arguments[2] : 120
            if(docObj.files && docObj.files[0]){
                //火狐下，直接设img属性
                imgObjPreview.style.display = 'inline-block';
                imgObjPreview.style.width = wid+'px';
                imgObjPreview.style.height = '120px';
                //imgObjPreview.src = docObj.files[0].getAsDataURL();

                //火狐7以上版本不能用上面的getAsDataURL()方式获取，需要一下方式
                imgObjPreview.src = window.URL.createObjectURL(docObj.files[0]);
            }else{
                //IE下，使用滤镜
                docObj.select();
                var imgSrc = document.selection.createRange().text;
                var localImagId = document.getElementById(localImg);
                //必须设置初始大小
                localImagId.style.width = wid+"px";
                localImagId.style.height = "80px";
                //图片异常的捕捉，防止用户修改后缀来伪造图片
                try{
                    localImagId.style.filter="progid:DXImageTransform.Microsoft.AlphaImageLoader(sizingMethod=scale)";
                    localImagId.filters.item("DXImageTransform.Microsoft.AlphaImageLoader").src = imgSrc;
                }catch(e){
                    alert("您上传的图片格式不正确，请重新选择!");
                    return false;
                }
                imgObjPreview.style.display = 'none';
                document.selection.empty();
            }
            return true;
        }

        function getSearchParams() {
            var params = {};
            var chunks = location.search.substr(1).split(/&/g);
            for (var i = 0; i < chunks.length; i++) {
                // 存储整个页面的数据
                try {
                    var items = chunks[i].split('=', 2);
                    var key = items[0];
                    var value = decodeURIComponent(items[1]);
                    params[key] = value;
                }
                catch (ex) {
                }
            }
            return params;
        }


       var param = getSearchParams();
        console.log(param)
    </script>


    <script type="text/javascript">
        //调用微信JS api 支付
        var offerdata;
        var orderdata;
        var coupondata;
            var getorder={
                url:'api/order/get/'+getSearchParams().id,
                type:'get',
                data:"",
                tokenFlag:false,
                sCallback:function(res){
                    if(res){
                        orderdata=res
                        console.log(res)
                    }else {
                        alert("获取订单信息失败")
                    }
                },
                eCallback:function(e){
                    //     showTip(e)
                }
            };
            window.base.getData(getorder);

        var getcoupon={
            url:'api/order/get/',
            type:'post',
            data:"",
            tokenFlag:true,
            sCallback:function(res){
                if(res){
                    coupondata=res
                    console.log(res)
                }else {

                }
            },
            eCallback:function(e){
                //     showTip(e)
            }
        };
        window.base.getData(getorder);

        function onBridgeReady(offerdata) {
            WeixinJSBridge.invoke(
                    'getBrandWCPayRequest',
                offerdata,
                    function (res) {
                        if (res.err_msg == "get_brand_wcpay_request:ok") {
                            alert('支付成功');
                            history.back();
                        }     // 使用以上方式判断前端返回,微信团队郑重提示:res.err_msg将在用户支付成功后返回    ok，但并不保证它绝对可靠。
                        if (res.err_msg == "get_brand_wcpay_request:cancel") {
                            alert('取消支付');
                            history.back();
                        }
                    }
            );
        }

        function callpay() {
            if (typeof WeixinJSBridge == "undefined") {
                if (document.addEventListener) {
                    document.addEventListener('WeixinJSBridgeReady', onBridgeReady, false);
                } else if (document.attachEvent) {
                    document.attachEvent('WeixinJSBridgeReady', onBridgeReady);
                    document.attachEvent('onWeixinJSBridgeReady', onBridgeReady);
                }
            } else {
                onBridgeReady(offerdata);
            }
        }
    </script>
    <script type="text/javascript">

     function offeroder() {
         var params={
             url:'api/user/pay/pre_order',
             type:'post',
             data:{"id":getSearchParams().id},
             tokenFlag:true,
             sCallback:function(res){
                 if(res){
                     offerdata=res
                     console.log(res)
                     callpay()
                 }else {
                     alert("获取支付信息失败")
                 }
             },
             eCallback:function(e){
                 //     showTip(e)
             }
         };
         window.base.getData(params);
     }
        



    </script>
</head>
<body>
<a class="pay" onclick="offeroder()">立即支付</a>
</body>
</html>